#!/bin/bash
# Join a Google Meet meeting using Camofox
# Usage: join-meeting <meeting-url>

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [ -z "$1" ]; then
    echo "‚ùå Error: No meeting URL provided"
    echo ""
    echo "Usage: join-meeting <meeting-url>"
    echo ""
    echo "Examples:"
    echo "  join-meeting https://meet.google.com/abc-defg-hij"
    echo "  join-meeting meet.google.com/abc-defg-hij"
    exit 1
fi

MEETING_URL="$1"

# Ensure it's a full URL
if [[ ! "$MEETING_URL" =~ ^https:// ]]; then
    MEETING_URL="https://$MEETING_URL"
fi

# Validate meeting URL against allowed providers (prevent SSRF)
ALLOWED_DOMAINS="meet.google.com|zoom.us|teams.microsoft.com|teams.live.com"
URL_HOST=$(echo "$MEETING_URL" | python3 -c "import sys; from urllib.parse import urlparse; print(urlparse(sys.stdin.read().strip()).hostname or '')")
if [[ ! "$URL_HOST" =~ ^($ALLOWED_DOMAINS)$ ]]; then
    echo "‚ùå Error: Invalid meeting URL domain: $URL_HOST"
    echo "Allowed: meet.google.com, zoom.us, teams.microsoft.com"
    exit 1
fi

echo "ü¶ä Joining Google Meet with Camofox..."
echo "Meeting: $MEETING_URL"
echo ""

cd "$SCRIPT_DIR"
node camofox-join.js "$MEETING_URL"
