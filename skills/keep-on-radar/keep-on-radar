#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPT="$SCRIPT_DIR/radar.py"

# Safe .env loading (no shell execution)
if [ -f "$HOME/.env" ]; then
    while IFS='=' read -r key value; do
        [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]] && continue
        key=$(echo "$key" | xargs)
        [[ "$key" =~ ^[A-Za-z_][A-Za-z_0-9]*$ ]] && export "$key=$value"
    done < "$HOME/.env"
fi

ACTION="${1:-review}"

case "$ACTION" in
    review)
        /usr/bin/python3 "$SCRIPT" review
        ;;

    check-replies)
        /usr/bin/python3 "$SCRIPT" check-replies
        ;;

    status)
        /usr/bin/python3 "$SCRIPT" status
        ;;

    pass)
        DEAL_ID="${2:-}"
        REASON="${3:-Passed via Keep on Radar review}"
        if [ -z "$DEAL_ID" ]; then
            echo "Usage: keep-on-radar pass <deal_id> [reason]"
            exit 1
        fi
        /usr/bin/python3 "$SCRIPT" pass "$DEAL_ID" "$REASON"
        ;;

    *)
        echo "Usage: keep-on-radar [review|check-replies|status|pass <deal_id> [reason]]"
        exit 1
        ;;
esac
