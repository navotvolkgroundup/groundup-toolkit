#!/bin/bash
# Get calendar for specific user by phone number
# Phone-to-email mappings are loaded from config.yaml via a Python helper.

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
TOOLKIT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Safe .env loading (line-by-line, no shell execution)
if [ -f "$TOOLKIT_ROOT/.env" ]; then
    while IFS='=' read -r key value; do
        [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]] && continue
        key=$(echo "$key" | xargs)
        [[ "$key" =~ ^[A-Za-z_][A-Za-z_0-9]*$ ]] && export "$key=$value"
    done < "$TOOLKIT_ROOT/.env" 2>/dev/null || true
fi

PHONE="$1"
MAX="${2:-10}"

if [ -z "$PHONE" ]; then
    echo "Usage: calendar-for-user <phone_number> [max_events]"
    echo "Phone-to-email mappings are defined in config.yaml"
    exit 1
fi

# Use Python config loader to resolve phone -> email
EMAIL=$(python3 -c "
import sys, os
sys.path.insert(0, sys.argv[1])
from lib.config import config
m = config.get_member_by_phone(sys.argv[2])
if m:
    print(m['email'])
else:
    sys.exit(1)
" "$TOOLKIT_ROOT" "$PHONE" 2>/dev/null)

if [ -z "$EMAIL" ]; then
    echo "Error: Phone number $PHONE not recognized"
    echo "Check config.yaml for known team members"
    exit 1
fi

# Calculate time range (next 7 days)
START=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
END=$(date -u -d "+7 days" +"%Y-%m-%dT%H:%M:%SZ")

echo "# Calendar for $EMAIL (phone: $PHONE)"
gog calendar events "$EMAIL" --from "$START" --to "$END" --max "$MAX"
