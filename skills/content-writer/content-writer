#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPT="$SCRIPT_DIR/writer.py"

# Safe .env loading (line-by-line, no shell execution)
while IFS='=' read -r key value; do
    [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]] && continue
    key=$(echo "$key" | xargs)
    [[ "$key" =~ ^[A-Za-z_][A-Za-z_0-9]*$ ]] && export "$key=$value"
done < "$HOME/.env" 2>/dev/null || true

ACTION="${1:-help}"
shift 2>/dev/null

case "$ACTION" in
    generate)
        MESSAGE="${1:-}"
        SENDER_PHONE="${2:-}"
        if [ -z "$MESSAGE" ] || [ -z "$SENDER_PHONE" ]; then
            echo "Usage: content-writer generate <message> <sender-phone>"
            exit 1
        fi
        /usr/bin/python3 "$SCRIPT" generate "$MESSAGE" "$SENDER_PHONE"
        ;;

    test)
        /usr/bin/python3 "$SCRIPT" test
        ;;

    *)
        echo "Content Writer â€” Generate content via WhatsApp"
        echo ""
        echo "Usage: content-writer <action> [args]"
        echo ""
        echo "Actions:"
        echo "  generate <message> <phone>  Generate content from request"
        echo "  test                        Run test generation"
        exit 0
        ;;
esac
